#!/bin/bash

"""
Download all pbf file for France regions
apply segmented building detection on them
generate osmose xml.
"""


RESULT_DIR=.
PREDICT=`dirname $0`/pbf_segmented_building_predict.py
FRANCE_PBF_LIST=`dirname $0`
FRANCE_PBF_LIST=`dirname $FRANCE_PBF_LIST`/data/france_pbf.txt
TMP_DIR=$TMP
if [ -z "$DOWNLOAD_DIR" ] ; then
    TMP_DIR=/tmp
fi
DOWNLOAD_DIR=$TMP_DIR


function download_pbfs {
    (while read region projection ; do
        url="http://download.geofabrik.de/europe/france/${region}-latest.osm.pbf"
        filename=`basename $url`
        filepath="$DOWNLOAD_DIR/$filename"
        #curl -s "$url" -o "$filepath"
        sleep 1
        echo $region $filepath $projection
    done) << EOT
        mayotte 32738
        guyane 2972
        corse 2154
        martinique 32620
        guadeloupe 32620
        reunion 2975
        limousin 2154
        champagne-ardenne 2154
        haute-normandie 2154
        franche-comte 2154
        basse-normandie 2154
        picardie 2154
        alsace 2154
        auvergne 2154
        bourgogne 2154
        lorraine 2154
        centre 2154
        nord-pas-de-calais 2154
        languedoc-roussillon 2154
        poitou-charentes 2154
        aquitaine 2154
        bretagne 2154
        ile-de-france 2154
        midi-pyrenees 2154
        provence-alpes-cote-d-azur 2154
        pays-de-la-loire 2154
        rhone-alpes 2154
EOT

    # donwload regions in inceasing size order 
    # to be sure that the predict pipe will always
    # be filled in

    read full_list_keept_for_record << EOT2
        mayotte 32738
        guyane 2972
        corse 2154
        martinique 32620
        guadeloupe 32620
        reunion 2975
        limousin 2154
        champagne-ardenne 2154
        haute-normandie 2154
        franche-comte 2154
        basse-normandie 2154
        picardie 2154
        alsace 2154
        auvergne 2154
        bourgogne 2154
        lorraine 2154
        centre 2154
        nord-pas-de-calais 2154
        languedoc-roussillon 2154
        poitou-charentes 2154
        aquitaine 2154
        bretagne 2154
        ile-de-france 2154
        midi-pyrenees 2154
        provence-alpes-cote-d-azur 2154
        pays-de-la-loire 2154
        rhone-alpes 2154
EOT2
}



echo "Start download..."

download_pbfs | while read region pbf projection ; do
   result="$RESULT_DIR/`basename $pbf .osm.pbf`.xml.bz2"
   echo "==========================================================>"
   echo "| $region $projection"
   echo "| $pbf => $result"
   $PREDICT $pbf $projection | bzip2 > $result
   #rm -f "$pbf"
done


